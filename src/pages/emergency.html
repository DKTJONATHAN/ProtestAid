<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Help - ProtestAid Kenya</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .emergency-card {
            transition: all 0.3s ease;
        }
        .emergency-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .availability-available {
            background-color: #dcfce7;
            color: #166534;
        }
        .availability-oncall {
            background-color: #fef9c3;
            color: #854d0e;
        }
        .availability-unavailable {
            background-color: #fee2e2;
            color: #991b1b;
        }
        #countySuggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            z-index: 1000;
            display: none;
        }
        #countySuggestions div {
            padding: 8px 12px;
            cursor: pointer;
        }
        #countySuggestions div:hover {
            background-color: #f0f0f0;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-4xl mx-auto py-8 px-4">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-red-600">Emergency Assistance</h1>
            <p class="mt-2 text-gray-600">Connect with volunteers in your area</p>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Emergency Selection Panel -->
            <div class="bg-white shadow-md rounded-xl p-6 emergency-card">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Select Emergency Type</h2>

                <div class="space-y-4">
                    <!-- Emergency Type Buttons -->
                    <div class="grid grid-cols-2 gap-3">
                        <button data-type="medic" class="emergency-type-btn py-3 px-4 border border-red-200 rounded-lg flex flex-col items-center justify-center bg-red-50 hover:bg-red-100 transition">
                            <i class="fas fa-plus-circle text-red-600 text-2xl mb-2"></i>
                            <span class="font-medium">Medical</span>
                        </button>
                        <button data-type="legal" class="emergency-type-btn py-3 px-4 border border-blue-200 rounded-lg flex flex-col items-center justify-center bg-blue-50 hover:bg-blue-100 transition">
                            <i class="fas fa-gavel text-blue-600 text-2xl mb-2"></i>
                            <span class="font-medium">Legal</span>
                        </button>
                        <button data-type="police" class="emergency-type-btn py-3 px-4 border border-purple-200 rounded-lg flex flex-col items-center justify-center bg-purple-50 hover:bg-purple-100 transition">
                            <i class="fas fa-shield-alt text-purple-600 text-2xl mb-2"></i>
                            <span class="font-medium">Police</span>
                        </button>
                        <button data-type="abduction" class="emergency-type-btn py-3 px-4 border border-yellow-200 rounded-lg flex flex-col items-center justify-center bg-yellow-50 hover:bg-yellow-100 transition">
                            <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl mb-2"></i>
                            <span class="font-medium">Abduction</span>
                        </button>
                    </div>

                    <!-- Location Detection -->
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-medium text-gray-800">Your Location</h3>
                                <p id="locationText" class="text-sm text-gray-500">Not yet detected</p>
                            </div>
                            <button id="detectLocationBtn" class="flex items-center space-x-2 bg-blue-50 hover:bg-blue-100 text-blue-600 px-4 py-2 rounded-lg transition">
                                <i class="fas fa-location-arrow"></i>
                                <span>Detect</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Help Options Panel -->
            <div class="bg-white shadow-md rounded-xl p-6 emergency-card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Available Volunteers</h2>
                    <div id="helpTypeBadge" class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm font-medium">
                        Select emergency type
                    </div>
                </div>

                <div id="helpOptions" class="space-y-4">
                    <!-- Initial state before selection -->
                    <div class="text-center py-10">
                        <i class="fas fa-hands-helping text-gray-300 text-4xl mb-3"></i>
                        <p class="text-gray-500">Please select an emergency type to see volunteers</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Information Section -->
        <div class="mt-6 bg-white shadow-md rounded-xl p-6 emergency-card">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Important Information</h2>
            <div class="prose prose-sm max-w-none">
                <p class="text-gray-600">All volunteers are shown regardless of availability status. When you call:</p>
                <ul class="list-disc pl-5 mt-2 space-y-1 text-gray-600">
                    <li>The volunteer will inform you if they're available to help</li>
                    <li>If unavailable, ask if they know other volunteers who might help</li>
                    <li>Be clear about your emergency and location</li>
                    <li>For critical emergencies, always call official emergency services first</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- County Selection Modal -->
    <div id="countyModal" class="modal">
        <div class="modal-content">
            <h3 class="font-semibold text-lg mb-4">Enter Your County</h3>
            <div class="relative">
                <input type="text" id="countyInput" placeholder="Start typing your county..." 
                       class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div id="countySuggestions" class="mt-1 rounded-lg shadow-lg"></div>
            </div>
            <div class="mt-4 flex justify-end space-x-2">
                <button id="cancelCountyBtn" class="px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-100">Cancel</button>
                <button id="confirmCountyBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Volunteer Template (Hidden) -->
    <template id="volunteerTemplate">
        <div class="p-4 border rounded-lg">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="font-medium text-gray-900" data-name>Volunteer Name</h3>
                    <div class="mt-1 flex items-center text-sm text-gray-500">
                        <i class="fas fa-map-marker-alt mr-1.5"></i>
                        <span data-location>Location</span>
                    </div>
                    <div class="mt-1 flex items-center text-sm text-gray-500">
                        <i class="fas fa-certificate mr-1.5"></i>
                        <span data-certifications>Certifications</span>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button class="call-btn inline-flex items-center justify-center h-10 w-10 rounded-full bg-green-100 text-green-600 hover:bg-green-200 transition">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="please-call-btn inline-flex items-center justify-center h-10 w-10 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 transition">
                        <i class="fas fa-phone-alt"></i>
                    </button>
                </div>
            </div>
            <div class="mt-3 pt-3 border-t border-gray-100 flex justify-between items-center">
                <span class="text-xs text-gray-400" data-distance>Distance calculating...</span>
                <span class="text-xs px-2 py-1 rounded-full" data-availability>Availability</span>
            </div>
        </div>
    </template>

    <script>
        // County coordinates - all 47 Kenyan counties
        const countyCoordinates = {
            "Nairobi": { lat: -1.286389, lng: 36.817223 },
            "Mombasa": { lat: -4.0435, lng: 39.6682 },
            "Kisumu": { lat: -0.1022, lng: 34.7617 },
            "Nakuru": { lat: -0.3031, lng: 36.0800 },
            "Kakamega": { lat: 0.2827, lng: 34.7519 },
            "Eldoret": { lat: 0.5204, lng: 35.2699 },
            "Thika": { lat: -1.0333, lng: 37.0833 },
            "Malindi": { lat: -3.2175, lng: 40.1191 },
            "Kiambu": { lat: -1.1667, lng: 36.8333 },
            "Machakos": { lat: -1.5167, lng: 37.2667 },
            "Meru": { lat: 0.0500, lng: 37.6500 },
            "Nyeri": { lat: -0.4167, lng: 36.9500 },
            "Kisii": { lat: -0.6833, lng: 34.7667 },
            "Kericho": { lat: -0.3667, lng: 35.2833 },
            "Bungoma": { lat: 0.5667, lng: 34.5667 },
            "Busia": { lat: 0.4667, lng: 34.1167 },
            "Embu": { lat: -0.5333, lng: 37.4500 },
            "Garissa": { lat: -0.4536, lng: 39.6400 },
            "Homa Bay": { lat: -0.5167, lng: 34.4500 },
            "Isiolo": { lat: 0.3500, lng: 37.5833 },
            "Kajiado": { lat: -1.8500, lng: 36.7833 },
            "Kilifi": { lat: -3.6333, lng: 39.8500 },
            "Kirinyaga": { lat: -0.5000, lng: 37.2833 },
            "Kitui": { lat: -1.3667, lng: 38.0167 },
            "Kwale": { lat: -4.1833, lng: 39.4500 },
            "Laikipia": { lat: 0.0333, lng: 36.3667 },
            "Lamu": { lat: -2.2697, lng: 40.9000 },
            "Makueni": { lat: -2.2833, lng: 37.8333 },
            "Mandera": { lat: 3.9333, lng: 41.8667 },
            "Marsabit": { lat: 2.3333, lng: 37.9833 },
            "Migori": { lat: -1.0667, lng: 34.4667 },
            "Murang'a": { lat: -0.7167, lng: 37.1500 },
            "Nyamira": { lat: -0.5667, lng: 34.9500 },
            "Nandi": { lat: 0.2000, lng: 35.1000 },
            "Narok": { lat: -1.0833, lng: 35.8667 },
            "Nyandarua": { lat: -0.5333, lng: 36.6000 },
            "Samburu": { lat: 1.1000, lng: 36.6667 },
            "Siaya": { lat: 0.0667, lng: 34.2833 },
            "Taita-Taveta": { lat: -3.4000, lng: 38.3667 },
            "Tana River": { lat: -1.5000, lng: 40.0167 },
            "Trans Nzoia": { lat: 1.0167, lng: 34.9833 },
            "Turkana": { lat: 3.1167, lng: 35.6000 },
            "Uasin Gishu": { lat: 0.5167, lng: 35.2833 },
            "Vihiga": { lat: 0.0833, lng: 34.7167 },
            "Wajir": { lat: 1.7500, lng: 40.0500 },
            "West Pokot": { lat: 1.2500, lng: 35.1000 }
        };

        // All Kenyan counties for autocomplete
        const allCounties = Object.keys(countyCoordinates);

        // DOM Elements
        const emergencyTypeBtns = document.querySelectorAll('.emergency-type-btn');
        const detectLocationBtn = document.getElementById('detectLocationBtn');
        const locationText = document.getElementById('locationText');
        const helpOptions = document.getElementById('helpOptions');
        const helpTypeBadge = document.getElementById('helpTypeBadge');
        const volunteerTemplate = document.getElementById('volunteerTemplate');
        const countyModal = document.getElementById('countyModal');
        const countyInput = document.getElementById('countyInput');
        const countySuggestions = document.getElementById('countySuggestions');
        const cancelCountyBtn = document.getElementById('cancelCountyBtn');
        const confirmCountyBtn = document.getElementById('confirmCountyBtn');

        // State
        let currentEmergencyType = null;
        let userLocation = null;
        let nearestCounty = null;
        let volunteersData = [];

        // Event Listeners
        emergencyTypeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                currentEmergencyType = btn.dataset.type;
                updateEmergencyTypeUI();
                if (nearestCounty) {
                    findVolunteers();
                } else {
                    helpOptions.innerHTML = `
                        <div class="text-center py-10">
                            <i class="fas fa-map-marker-alt text-gray-300 text-4xl mb-3"></i>
                            <p class="text-gray-500">Please detect your location first</p>
                        </div>
                    `;
                }
            });
        });

        detectLocationBtn.addEventListener('click', detectUserLocation);

        // County selection modal events
        countyInput.addEventListener('input', showCountySuggestions);
        cancelCountyBtn.addEventListener('click', closeCountyModal);
        confirmCountyBtn.addEventListener('click', confirmCountySelection);

        // Load volunteer data from GitHub raw content
        async function loadVolunteerData() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/DKTJONATHAN/ProtestAid/main/data/volunteers.json');
                
                if (!response.ok) {
                    throw new Error('Failed to load volunteer data');
                }
                
                volunteersData = await response.json();
                console.log('Volunteer data loaded:', volunteersData);
            } catch (error) {
                console.error('Error loading volunteer data:', error);
                helpOptions.innerHTML = `
                    <div class="text-center py-10">
                        <i class="fas fa-exclamation-triangle text-red-300 text-4xl mb-3"></i>
                        <p class="text-gray-500">Failed to load volunteer data</p>
                        <p class="text-sm text-gray-400 mt-2">${error.message}</p>
                    </div>
                `;
            }
        }

        // Initialize by loading volunteer data
        loadVolunteerData();

        // Update emergency type UI
        function updateEmergencyTypeUI() {
            emergencyTypeBtns.forEach(btn => {
                btn.classList.remove('ring-2', 'ring-offset-2');
                if (btn.dataset.type === currentEmergencyType) {
                    const colorClass = {
                        medic: 'ring-red-500',
                        legal: 'ring-blue-500',
                        police: 'ring-purple-500',
                        abduction: 'ring-yellow-500'
                    }[currentEmergencyType];
                    btn.classList.add('ring-2', 'ring-offset-2', colorClass);
                }
            });

            const typeNames = {
                medic: 'Medical',
                legal: 'Legal',
                police: 'Police',
                abduction: 'Abduction'
            };
            helpTypeBadge.textContent = typeNames[currentEmergencyType] || 'Select type';
            helpTypeBadge.className = `px-3 py-1 rounded-full text-sm font-medium ${
                currentEmergencyType ? 
                {
                    medic: 'bg-red-100 text-red-600',
                    legal: 'bg-blue-100 text-blue-600',
                    police: 'bg-purple-100 text-purple-600',
                    abduction: 'bg-yellow-100 text-yellow-600'
                }[currentEmergencyType] : 'bg-gray-100 text-gray-600'
            }`;
        }

        // Detect user location
        function detectUserLocation() {
            detectLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Detecting...';
            detectLocationBtn.disabled = true;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        determineNearestCounty();
                        locationText.textContent = `Detected in ${nearestCounty}`;
                        detectLocationBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Detected';
                        detectLocationBtn.disabled = false;

                        if (currentEmergencyType) {
                            findVolunteers();
                        }
                    },
                    error => {
                        console.error("Location error:", error);
                        locationText.textContent = "Could not detect location";
                        detectLocationBtn.innerHTML = '<i class="fas fa-location-arrow mr-2"></i> Try Again';
                        detectLocationBtn.disabled = false;

                        // Show manual county entry modal
                        showCountyModal();
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            } else {
                locationText.textContent = "Geolocation not supported";
                detectLocationBtn.innerHTML = '<i class="fas fa-times-circle mr-2"></i> Not Supported';
                // Show manual county entry modal
                showCountyModal();
            }
        }

        // Show county selection modal
        function showCountyModal() {
            countyModal.style.display = 'flex';
            countyInput.value = '';
            countySuggestions.innerHTML = '';
            countySuggestions.style.display = 'none';
            countyInput.focus();
        }

        // Close county selection modal
        function closeCountyModal() {
            countyModal.style.display = 'none';
        }

        // Confirm county selection from modal
        function confirmCountySelection() {
            const selectedCounty = countyInput.value.trim();
            if (selectedCounty && allCounties.some(c => c.toLowerCase() === selectedCounty.toLowerCase())) {
                nearestCounty = allCounties.find(c => c.toLowerCase() === selectedCounty.toLowerCase());
                locationText.textContent = `Using ${nearestCounty}`;
                closeCountyModal();

                if (currentEmergencyType) {
                    findVolunteers();
                }
            } else {
                alert("Please select a valid county from the suggestions");
            }
        }

        // Show county suggestions based on input
        function showCountySuggestions() {
            const input = countyInput.value.toLowerCase();
            if (input.length === 0) {
                countySuggestions.style.display = 'none';
                return;
            }

            const matches = allCounties.filter(county => 
                county.toLowerCase().includes(input)
            );

            if (matches.length > 0) {
                countySuggestions.innerHTML = matches.map(county => 
                    `<div onclick="selectCountySuggestion('${county}')">${county}</div>`
                ).join('');
                countySuggestions.style.display = 'block';
            } else {
                countySuggestions.style.display = 'none';
            }
        }

        // Select a county from suggestions
        function selectCountySuggestion(county) {
            countyInput.value = county;
            countySuggestions.style.display = 'none';
        }

        // Make selectCountySuggestion available globally
        window.selectCountySuggestion = selectCountySuggestion;

        // Determine nearest county
        function determineNearestCounty() {
            if (!userLocation) return;

            let nearest = null;
            let shortestDistance = Infinity;

            for (const [county, coords] of Object.entries(countyCoordinates)) {
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    coords.lat, coords.lng
                );

                if (distance < shortestDistance) {
                    shortestDistance = distance;
                    nearest = county;
                }
            }

            nearestCounty = nearest;
        }

        // Calculate distance between coordinates
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Find and display volunteers
        function findVolunteers() {
            console.log("Current filters:", {
                type: currentEmergencyType,
                county: nearestCounty,
                dataCount: volunteersData.length
            });

            if (!currentEmergencyType || !nearestCounty || volunteersData.length === 0) {
                helpOptions.innerHTML = `
                    <div class="text-center py-10">
                        <i class="fas fa-exclamation-triangle text-yellow-300 text-4xl mb-3"></i>
                        <p class="text-gray-500">System not ready</p>
                        <p class="text-sm text-gray-400 mt-2">Type: ${currentEmergencyType || 'none'}, 
                        Location: ${nearestCounty || 'none'}, 
                        Volunteers: ${volunteersData.length}</p>
                    </div>
                `;
                return;
            }

            const matchedVolunteers = volunteersData.filter(volunteer => {
                const matches = (volunteer.serviceType || '').toLowerCase() === currentEmergencyType.toLowerCase() && 
                              volunteer.location && 
                              volunteer.location.toLowerCase().includes(nearestCounty.toLowerCase());
                console.log(`Volunteer ${volunteer.fullName} matches:`, matches);
                return matches;
            });

            console.log("Matched volunteers:", matchedVolunteers);

            if (matchedVolunteers.length === 0) {
                helpOptions.innerHTML = `
                    <div class="text-center py-10">
                        <i class="fas fa-user-slash text-gray-300 text-4xl mb-3"></i>
                        <p class="text-gray-500">No ${currentEmergencyType} volunteers found in ${nearestCounty}</p>
                        <p class="text-sm text-gray-400 mt-2">Available volunteers: ${volunteersData.length}</p>
                    </div>
                `;
                return;
            }

            displayVolunteers(matchedVolunteers);
        }

        // Display volunteers
        function displayVolunteers(volunteers) {
            helpOptions.innerHTML = '';

            volunteers.forEach(volunteer => {
                const volunteerCard = volunteerTemplate.content.cloneNode(true);

                // Fill volunteer data
                volunteerCard.querySelector('[data-name]').textContent = volunteer.fullName;
                volunteerCard.querySelector('[data-location]').textContent = volunteer.location;
                volunteerCard.querySelector('[data-certifications]').textContent = 
                    volunteer.certifications?.join(', ') || 'Not specified';

                // Set availability
                const availabilityEl = volunteerCard.querySelector('[data-availability]');
                availabilityEl.textContent = volunteer.availability || 'unknown';

                // Style based on availability
                if (volunteer.availability?.toLowerCase().includes('available')) {
                    availabilityEl.classList.add('availability-available');
                } else if (volunteer.availability?.toLowerCase().includes('on-call')) {
                    availabilityEl.classList.add('availability-oncall');
                } else {
                    availabilityEl.classList.add('availability-unavailable');
                }

                // Calculate distance
                const countyCoords = countyCoordinates[volunteer.location];
                if (countyCoords && userLocation) {
                    const distance = calculateDistance(
                        userLocation.lat, userLocation.lng,
                        countyCoords.lat, countyCoords.lng
                    );
                    volunteerCard.querySelector('[data-distance]').textContent = `~${Math.round(distance)} km away`;
                }

                // Set up call buttons
                const phoneNumber = volunteer.phone || volunteer.emergencyContact1;
                const callBtn = volunteerCard.querySelector('.call-btn');
                const pleaseCallBtn = volunteerCard.querySelector('.please-call-btn');

                if (phoneNumber) {
                    callBtn.addEventListener('click', () => {
                        window.location.href = `tel:${phoneNumber}`;
                    });

                    pleaseCallBtn.addEventListener('click', () => {
                        // Correct Safaricom/Airtel Please Call Me code for Kenya (*130#)
                        const pleaseCallCode = `*130*${phoneNumber.replace(/\D/g, '')}%23`;
                        window.location.href = `tel:${pleaseCallCode}`;
                    });
                } else {
                    callBtn.disabled = true;
                    pleaseCallBtn.disabled = true;
                    callBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    pleaseCallBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }

                helpOptions.appendChild(volunteerCard);
            });
        }
    </script>
</body>
</html>